#<!-- NOTE: Leave this first line as is, # must be visble in HTML as first character.
############## Fancy Ascii-Art Title #########################
# NOTE: font adapted from https://textkool.com/en/ascii-art-generator?hl=default&vl=default&font=3x5
#--><pre style="line-height:.5">
#      ###     # #              ##     # #     ##  <br>
#      ##       #              #       # #     # # <br>
#      ###     # #      #      #       ###     # # <br></pre> <!--
############## Powershell stuff goes below here #########################
# & powershell
# 
# NOTE: To avoid PS outtputting errors, don't leave any newlines here without a PS comments (#).
#
### Config:
#
$error.clear()
##REQUIRED: Must change the following 3 to match your github:
$githubURL = "https://github.com/Xyvir/iex.run" # R
$DownloadFolder = '$Env:Public\$github\' # Default '$Env:Public\$github\'
#
# These configs can be toggled via 'meta-parameters' in the URL query string, by prefacing with an @ instead of $
$SkipStubScriptDL = $false       # Default $false
$NoWildcardMatch = $false        # Default is $false
$NoExecute = $false              # Default is $false
$DebugVars = $false              # show all vars created, default $false
$Uninstall = $false              #
#
### Init:
#
$OldProgress = $ProgressPreference; $ProgressPreference = "SilentlyContinue"
$github = ([uri]$githubURL).Segments | Select -Last 1
$invoc = $myinvocation | Select MyCommand | Format-Table -hidetableheaders | Out-String
$invoc1 = $myinvocation | Select MyCommand | Format-Table -hidetableheaders | Out-String
$invoc2 = $myinvocation | Select -ExpandProperty MyCommand  
$invoc = $invoc.split("`"")
$invoc = [string]::join("",($invoc.Split("`n")))
$invoc = $invoc.Replace(' | iex', '')
$curl = $invoc.SubString(0, $invoc.LastIndexOf(' '))
$invocuri2 = $invoc.Replace($curl + " ","")
$invoc = $invoc.Split(" ")
$invocuri = [uri]("https://" + ($invoc | Select -Last 1))
$command = ($invocuri.Absolutepath).Trim("/")
$arguments = ($invocuri.Query).Split("?")
foreach ($item in $arguments) {if ($item -like '`@*') {$trimitem = $item.trim('@'); if (test-Path variable:$trimitem) { Set-Variable -Name $trimitem -Value (!(Get-Variable -Name $trimitem).value) } } }
#$fileURLs = (invoke-webrequest $githubURL).Links | Where-Object {$_.href -like "*blob*"} | Select -ExpandProperty href
#$Filematch = Foreach ($url in $fileURLs) { $url -split "/" | Select -Last 1 | Select-String -Pattern '(CNAME)|(404.html)' -NotMatch }
$DownloadFolder = $ExecutionContext.InvokeCommand.ExpandString($DownloadFolder)
$apiurl = "https://api.github.com/repos" + ([uri]$githubURL).AbsolutePath + "/contents"
$api = ConvertFrom-Json (invoke-webrequest $apiurl).content
$list = foreach ($item in $api) {if ($item.name -ne 'CNAME' -and $item.name -ne '404.html'-and $item.name -ne '.gitattributes' -and $item.name -ne '.github' -and $item.name -ne '.gitignore') {$item | Select -Property name, size, sha} }
$symbol = [char]25 + [char]30 + [char]19
$list | Add-Member -MemberType NoteProperty -Name '?' -Value ''
# Status Icons [char]25 + [char]30 + [char]19
#
### Execute:
#
set-executionpolicy -force -scope process unrestricted
$env:Path += ";$DownloadFolder;"
if ($DebugVars) {get-variable | where-object {(@("FormatEnumerationLimit", "MaximumAliasCount", "MaximumDriveCount", "MaximumErrorCount", "MaximumFunctionCount", "MaximumVariableCount", "PGHome", "PGSE", "PGUICulture", "PGVersionTable", "PROFILE", "PSSessionOption") -notcontains $_.name) -and (([psobject].Assembly.GetType('System.Management.Automation.SpecialVariables').GetFields('NonPublic,Static') | Where-Object FieldType -eq ([string]) | ForEach-Object GetValue $null)) -notcontains $_.name}}
echo "@set PATH=%PATH%;$DownloadFolder; `n @powershell -c `"curl.exe \`"%~n0/%1\`" | iex`" || dir $DownloadFolder" | out-file $Env:localappdata\Microsoft\WindowsApps\$github.cmd -encoding ascii
Write-Output ""
$DownloadUrl = ($api | Where-Object {$_.name -like "*$command*"}).download_url
$sha = ($api | Where-Object {$_.name -like "*$command*"}).sha
if ($command) {$exe = $DownloadUrl.substring($DownloadUrl.LastIndexOf('/') + 1, $DownloadUrl.length - $DownloadUrl.LastIndexOf('/') - 1 )}
pushd $DownloadFolder
if (!$command) {$files = @(Get-ChildItem *); $files | Add-Member -MemberType NoteProperty -Name 'sha' -value ''; foreach ($file in $files) {$file.sha = Get-Content -Path $file.name -Stream sha -ErrorAction SilentlyContinue}}
if ($command) {Write-Host "Downloading '$exe' to '$DownloadFolder'" -ForegroundColor Yellow; Write-Output ""}
if ($command) {curl.exe -# -O $DownloadUrl; if (Test-Path -Path $exe -PathType Leaf) {Set-Content -Path $exe -Stream sha -value $sha} }
if ($command) {Set-Content -Path $exe -Stream sha -value $sha}
popd
if ($command) {Set-Clipboard $invocuri}
If (!$command) {$status = Compare-Object -ReferenceObject $list -DifferenceObject $files -Property name,sha -IncludeEqual}
If (!$command) {$orphans = Compare-Object -ReferenceObject $list -DifferenceObject $files -Property name | Select name, @{E={$_.SideIndicator};L="orphan"}}
If (!$command) {foreach ($thing in $status){$thing.SideIndicator = $thing.SideIndicator -replace("==",[char]25) -replace("<=","") -replace("=>",[char]18); if (($orphans | Where-Object {$_.name -eq $thing.name}).orphan -eq "=>") {$thing.SideIndicator = [char]19} }}
If (!$command) {Write-Host "Available Files and Status :" -ForegroundColor Yellow; Write-Output $status | Select  name, @{E={$_.SideIndicator}; L="?"} | Format-Table -Autosize}
Write-Output ""
if (!$error) {Write-Host "iex.run Complete!" -ForegroundColor Green} else {Write-Host "iex.run completed with errors: `n`n $error" -ForegroundColor Red}
if ($command) {Write-Output ""; Write-Output "The corresponding 'Magic URL': `"$invocuri`" has been copied to your clipboard."}
Write-Output ""
#
### Cleanup:
#
$ProgressPreference = $OldProgress
#
### Optional Uninstall:
#
#################### HTML stuff goes below here #########################
# Let the insane cross-commenting begin.
#--><!DOCTYPE html><!--
#--><html><body><!--
#--><div style = "margin-left:25%"><!--
#--><p>1. Click the 'Copy' button below.</p><!--
#--><button onclick="myFunction()">Copy</button><!--
#--><input type="text" value="powershell -noexit -c curl.exe" id="myInput" size="50" readonly=""><!--
#--><p>2. Press Winkey and 'R' together. ( &#x229E  + R ) NOTE: Windows key is located between CTRL and ALT. </p><!--
#--><p>3. Paste. (CTRL +V)</p><!--
#--><p>4. Press Enter.</p><!--
#--><p>5. If prompted, click 'Yes' on the 'Do you want to allow this app...' pop-up. </p><!--
#--><p>6. Please wait until you see the message 'iex.run Complete!' </p><!--
#--><p>NOTE: If anything goes wrong, or you are still having issues, please inform your IT department. </p><!--
#--><p id="demo"></p><!--
#--></div><!--
#--><p style="font-size:0px;">+</p><!--
#--><p style="font-size:0px;">+</p><!--
#--><p style="font-size:0px;">If you are seeing this text in red, you may have forgotten to add '.exe' to your 'curl.exe' command.</p><!--
#--><p style="font-size:0px;">+</p><!--
#--><p style="font-size:0px;">+</p><!--
#--><script>/*
#*/function myFunction() {/*
#*/  var copyText = document.getElementById("myInput");/*
#*/  copyText.select();/*
#*/ copyText.setSelectionRange(0, 99999)/*
#*/  document.execCommand("copy");/*
#*/}/*
#*/document.getElementById("myInput").value = /*
#*/"powershell -noexit -c \"curl.exe " + window.location.hostname + window.location.pathname + window.location.search + " | iex\"";/*
#*/</script><!--
#--><footer style="position: fixed; bottom: 0; text-align: right">What is this?</footer><!--
#--></body></html><!--
#
#
# If you are seeing this message, you may have forgotten to add '| iex' to the end of your curl.exe command. 
#
#
#-->
